<div class="mx-auto max-w-2xl p-4 md:p-6">
  <div
    class="rounded-2xl border border-neutral-200/60 bg-white shadow dark:border-neutral-800 dark:bg-neutral-900"
  >
    <div class="p-4 md:p-6">
      <h2 class="mb-4 text-xl font-semibold tracking-tight md:text-2xl">
        {{ isEdit ? 'Edit Task' : 'New Task' }}
      </h2>

      <form [formGroup]="form" (ngSubmit)="save()" class="grid gap-4">
        <div class="grid gap-1.5">
          <label class="text-sm font-medium">Level</label>
          <select
            class="w-full rounded-xl border border-neutral-300 px-3 py-2"
            formControlName="levelId"
          >
            <option [ngValue]="null" disabled>Select level</option>
            <ng-container *ngIf="levels$ | async as levels">
              <option *ngFor="let l of levels" [ngValue]="l.id">{{ l.name }}</option>
            </ng-container>
          </select>
        </div>

        <div class="grid gap-1.5">
          <label class="text-sm font-medium">Internal name</label>
          <input
            class="w-full rounded-xl border border-neutral-300 px-3 py-2"
            formControlName="internalName"
            placeholder="Task internal name"
          />
        </div>

        <div class="grid gap-1.5">
          <label class="text-sm font-medium">Task type</label>
          <select
            class="w-full rounded-xl border border-neutral-300 px-3 py-2"
            formControlName="type"
          >
            <option value="anagram">Build the word</option>
            <option value="image_choice">Image choice</option>
            <option value="text_choice">Text choice</option>
          </select>
        </div>

        <div class="grid gap-1.5">
          <label class="text-sm font-medium">Header text</label>
          <textarea
            rows="2"
            class="w-full rounded-xl border border-neutral-300 px-3 py-2"
            formControlName="headerText"
          ></textarea>
        </div>

        <div class="grid gap-1.5">
          <div class="flex items-center justify-between gap-3">
            <label class="text-sm font-medium">Task media</label>
            <select
              class="rounded-xl border border-neutral-300 px-3 py-1 text-sm"
              [value]="taskMediaType"
              (change)="onTaskMediaTypeChange($any($event.target).value)"
            >
              <option value="image">Image</option>
              <option value="video">Video</option>
            </select>
          </div>
          <ng-container [ngSwitch]="taskMediaType">
            <app-image-picker
              *ngSwitchCase="'image'"
              formControlName="imagePath"
              [mode]="'original'"
              label="Image (optional)"
            ></app-image-picker>
            <app-video-picker
              *ngSwitchCase="'video'"
              formControlName="imagePath"
              label="Video (optional)"
            ></app-video-picker>
          </ng-container>
        </div>

        <div class="grid gap-1.5">
          <label class="text-sm font-medium">Task media source</label>
          <input
            class="w-full rounded-xl border border-neutral-300 px-3 py-2"
            formControlName="taskImageSource"
            placeholder="<a href='https://example.com/source'>source</a>"
          />
        </div>

        <div class="grid gap-1.5">
          <div class="flex items-center justify-between gap-3">
            <label class="text-sm font-medium">Result media</label>
            <select
              class="rounded-xl border border-neutral-300 px-3 py-1 text-sm"
              [value]="resultMediaType"
              (change)="onResultMediaTypeChange($any($event.target).value)"
            >
              <option value="image">Image</option>
              <option value="video">Video</option>
            </select>
          </div>
          <ng-container [ngSwitch]="resultMediaType">
            <app-image-picker
              *ngSwitchCase="'image'"
              formControlName="resultImagePath"
              [mode]="'original'"
              label="Image (optional)"
            ></app-image-picker>
            <app-video-picker
              *ngSwitchCase="'video'"
              formControlName="resultImagePath"
              label="Video (optional)"
            ></app-video-picker>
          </ng-container>
        </div>

        <div class="grid gap-1.5">
          <label class="text-sm font-medium">Result media source</label>
          <input
            class="w-full rounded-xl border border-neutral-300 px-3 py-2"
            formControlName="resultImageSource"
            placeholder="<a href='https://example.com/source'>source</a>"
          />
        </div>

        <div class="grid grid-cols-1 gap-1.5 md:grid-cols-3 md:gap-3">
          <div>
            <label class="text-sm font-medium">Order</label>
            <input
              type="number"
              inputmode="numeric"
              min="0"
              class="w-full rounded-xl border border-neutral-300 px-3 py-2"
              formControlName="orderIndex"
              placeholder="0,1,2..."
            />
          </div>
          <div>
            <label class="text-sm font-medium">Status</label>
            <select
              class="w-full rounded-xl border border-neutral-300 px-3 py-2"
              formControlName="status"
            >
              <option [value]="1">Published</option>
              <option [value]="0">Draft</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium">Time (sec, optional)</label>
            <input
              type="number"
              inputmode="numeric"
              min="0"
              class="w-full rounded-xl border border-neutral-300 px-3 py-2"
              formControlName="timeLimitSec"
              placeholder="e.g., 90"
            />
          </div>
        </div>

        <div class="grid grid-cols-1 gap-1.5 md:grid-cols-3 md:gap-3">
          <div>
            <label class="text-sm font-medium">Points (1st try)</label>
            <input
              type="number"
              inputmode="numeric"
              min="0"
              class="w-full rounded-xl border border-neutral-300 px-3 py-2"
              formControlName="pointsAttempt1"
            />
          </div>
          <div>
            <label class="text-sm font-medium">Points (2nd try)</label>
            <input
              type="number"
              inputmode="numeric"
              min="0"
              class="w-full rounded-xl border border-neutral-300 px-3 py-2"
              formControlName="pointsAttempt2"
            />
          </div>
          <div>
            <label class="text-sm font-medium">Points (3rd try)</label>
            <input
              type="number"
              inputmode="numeric"
              min="0"
              class="w-full rounded-xl border border-neutral-300 px-3 py-2"
              formControlName="pointsAttempt3"
            />
          </div>
        </div>

        <div class="grid gap-1.5">
          <label class="text-sm font-medium">Explanation text</label>
          <textarea
            rows="2"
            class="w-full rounded-xl border border-neutral-300 px-3 py-2"
            formControlName="explanationText"
          ></textarea>
        </div>

        <!-- Type: anagram -->
        <div
          *ngIf="form.value.type === 'anagram'"
          class="grid gap-1.5 rounded-xl border border-neutral-200 p-3"
        >
          <div class="text-sm font-semibold">Build the word</div>
          <label class="text-sm">Characters list (comma-separated)</label>
          <input
            class="w-full rounded-xl border border-neutral-300 px-3 py-2"
            formControlName="charsCsv"
            placeholder="B,E,R,L,I,N"
          />
          <label class="text-sm">Correct answer</label>
          <input
            class="w-full rounded-xl border border-neutral-300 px-3 py-2"
            formControlName="correctAnswer"
            placeholder="BERLIN"
          />
        </div>

        <!-- Type: image_choice / text_choice -->
        <div
          *ngIf="form.value.type === 'image_choice' || form.value.type === 'text_choice'"
          class="grid gap-2 rounded-xl border border-neutral-200 p-3"
        >
          <div class="text-sm font-semibold">Answer options</div>

          <!-- ВАЖНО: formArrayName + formGroupName вместо [formGroup]="opt" -->
          <ng-container formArrayName="options">
            <ng-container *ngFor="let opt of options.controls; let i = index">
              <div [formGroupName]="i" class="grid gap-2 rounded-xl border border-neutral-200 p-2">
                <div class="grid gap-3">
                  <div class="grid gap-1.5 md:grid-cols-2 md:gap-3">
                    <input
                      class="rounded-xl border border-neutral-300 px-3 py-2"
                      formControlName="label"
                      placeholder="Label"
                    />
                    <label class="inline-flex items-center gap-2">
                      <input type="checkbox" formControlName="isCorrect" />
                      Correct answer
                    </label>
                  </div>
                  <div *ngIf="form.value.type === 'image_choice'">
                    <app-image-picker
                      formControlName="imageUrl"
                      [mode]="'original'"
                      [previewWidth]="200"
                      [previewHeight]="120"
                    ></app-image-picker>
                  </div>
                </div>

                <div class="flex justify-end">
                  <button
                    type="button"
                    (click)="removeOption(i)"
                    class="rounded-xl border px-3 py-1 hover:bg-neutral-50"
                  >
                    Remove option
                  </button>
                </div>
              </div>
            </ng-container>
          </ng-container>

          <button
            type="button"
            (click)="addOption()"
            class="rounded-xl border px-3 py-2 hover:bg-neutral-50"
          >
            + Add option
          </button>
        </div>

        <div class="mt-2 flex flex-col gap-2 md:flex-row">
          <button
            type="submit"
            [disabled]="form.invalid"
            class="rounded-xl bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
          >
            {{ isEdit ? 'Save' : 'Create' }}
          </button>
          <button
            type="button"
            (click)="cancel()"
            class="rounded-xl border border-neutral-300 px-4 py-2 hover:bg-neutral-50"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
