<div class="task-container">
  <ng-container *ngIf="showIntro; else taskFlow">
    <div class="intro-overlay">
      <div *ngIf="introLoading" class="intro-loading">
        <div class="loading-spinner"></div>
        <p>Preparing the level...</p>
      </div>

      <div *ngIf="introError && !introLoading" class="intro-error">
        <div class="error-icon">⚠️</div>
        <p>{{ introError }}</p>
        <button class="retry-button" (click)="retryIntro()">Try Again</button>
      </div>

      <ng-container *ngIf="!introLoading && !introError && levelIntro">
        <div class="intro-panel" *ngIf="!showAnimationImage">
          <div class="intro-header">
            <div class="intro-header-label">
              {{ levelIntro.headerText || levelIntro.levelName }}
            </div>
          </div>
        </div>

        <!-- start button moved into intro-overlay (sibling of intro-panel) so it's visually part of the overlay -->
        <button
          *ngIf="!showAnimationImage"
          class="intro-start-button"
          (click)="onStartLevel()"
          [disabled]="animationPlaying"
        >
          {{ 'game.intro.start' | translate }}
        </button>

        <div
          *ngIf="showAnimationImage && levelIntro.animationImageUrl"
          class="intro-animation-layer"
        >
          <img
            [src]="levelIntro.animationImageUrl"
            alt="Level intro animation"
            class="intro-animation-image"
            [class.playing]="animationPlaying"
            (animationend)="onIntroAnimationDone()"
            (error)="onIntroAnimationError()"
          />
        </div>
      </ng-container>
    </div>
  </ng-container>

  <ng-template #taskFlow>
    <!-- Loading state -->
    <div *ngIf="loading" class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading task...</p>
    </div>

    <!-- Error state -->
    <div *ngIf="error && !loading" class="error-state">
      <div class="error-icon">⚠️</div>
      <p>{{ error }}</p>
      <button class="retry-button" (click)="loadCurrentTask()">Retry</button>
    </div>

    <!-- Main task content -->
    <div *ngIf="!loading && !error && task" class="task-content">
      <!-- Timer -->
      <div *ngIf="task.timeLimitSecEffective" class="timer-container">
        <div class="timer" [class]="getTimerClass()">
          {{ formatTime(timeRemaining) }}
        </div>
        <div class="timer-bar">
          <div
            class="timer-fill"
            [style.width.%]="(timeRemaining / task.timeLimitSecEffective) * 100"
          ></div>
        </div>
      </div>

      <!-- Task header -->
      <div class="task-header">
        <h2
          *ngIf="!isGapFillTask"
          class="task-title"
          [innerHTML]="task.headerText || ('game.task.defaultTitle' | translate)"
        ></h2>

        <div *ngIf="isGapFillTask" class="task-title gap-fill-header">
          <ng-container *ngIf="gapFillSegments.length; else gapFillFallback">
            <ng-container *ngFor="let segment of gapFillSegments">
              <ng-container *ngIf="segment.type === 'text'">{{ segment.value }}</ng-container>
              <select
                *ngIf="segment.type === 'blank'"
                class="gap-fill-select"
                [value]="gapFillSelections[segment.index]"
                (change)="onGapFillChange(segment.index, $event)"
                [disabled]="incorrectFeedback || showingExplanation"
              >
                <option value="" disabled [selected]="!gapFillSelections[segment.index]" hidden>
                  ...
                </option>
                <option *ngFor="let option of segment.options" [value]="option">
                  {{ option }}
                </option>
              </select>
            </ng-container>
          </ng-container>
          <ng-template #gapFillFallback>
            {{ task.headerText || ('game.task.defaultTitle' | translate) }}
          </ng-template>
        </div>
      </div>

      <div *ngIf="incorrectFeedback && incorrectMessage" class="incorrect-feedback">
        {{ incorrectMessage }}
      </div>

      <!-- Task image -->
      <div *ngIf="displayedImageUrl as imageUrl" class="task-image-container">
        <ng-container *ngIf="isVideoUrl(imageUrl); else taskImage">
          <video
            [src]="imageUrl"
            class="task-image"
            controls
            autoplay
            muted
            playsinline
          ></video>
        </ng-container>
        <ng-template #taskImage>
          <img
            [src]="imageUrl"
            [alt]="showingExplanation && task.resultImagePath ? 'Result image' : 'Task image'"
            class="task-image"
          />
        </ng-template>
        <div
          *ngIf="displayedImageSource as imageSource"
          class="image-source"
          [innerHTML]="imageSource"
        ></div>
      </div>

      <!-- Options -->
      <ng-container *ngIf="isAnagramTask; else defaultTaskOptions">
        <div
          class="anagram-section"
          *ngFor="let option of task.options; let i = index; trackBy: trackOption"
        >
          <ng-container *ngIf="getAnagramState(option, i) as state">
            <div class="anagram-pieces result-zone">
              <button
                type="button"
                class="anagram-piece"
                *ngFor="let piece of state.result"
                (click)="movePieceToSource(getAnagramKey(option, i), piece.id)"
                [disabled]="incorrectFeedback || showingExplanation"
              >
                {{ piece.text }}
              </button>
              <div *ngIf="state.result.length === 0" class="anagram-placeholder">
                {{ 'game.task.anagram.resultHint' | translate }}
              </div>
            </div>
            <div class="anagram-divider" aria-hidden="true"></div>
            <div class="anagram-pieces available-zone">
              <button
                type="button"
                class="anagram-piece"
                *ngFor="let piece of state.available"
                (click)="movePieceToResult(getAnagramKey(option, i), piece.id)"
                [disabled]="incorrectFeedback || showingExplanation"
              >
                {{ piece.text }}
              </button>
              <div *ngIf="state.available.length === 0" class="anagram-placeholder">
                {{ 'game.task.anagram.availableHint' | translate }}
              </div>
            </div>
          </ng-container>
        </div>
      </ng-container>
      <ng-template #defaultTaskOptions>
        <div *ngIf="isMatchingTask; else standardOptions" class="matching-container">
          <div class="matching-header">
            <div class="matching-title">
              <span class="matching-icon" aria-hidden="true">◎</span>
              <div class="matching-title-text">
                <span class="matching-label">Matching</span>
                <div class="matching-headline">
                  {{ 'game.task.matching.instructions' | translate }}
                </div>
               
              </div>
            </div>
            <div class="matching-progress">
              <div class="progress-track" aria-hidden="true">
                <div
                  class="progress-fill"
                  [style.width.%]="(matchingPairs.length / matchingLeftOptions.length) * 100"
                ></div>
              </div>
              <div class="progress-count">
                {{ matchingPairs.length }} / {{ matchingLeftOptions.length }}
              </div>
              
            </div>
          </div>

          <div class="matching-columns">
            <div class="matching-column">
              <button
                type="button"
                class="matching-option"
                *ngFor="let option of availableMatchingLeftOptions"
                (click)="onSelectMatchingLeft(option.id)"
                [class.selected]="isLeftSelected(option.id)"
                [disabled]="incorrectFeedback || showingExplanation"
              >
                {{ option.text }}
              </button>
            </div>
            <div class="matching-divider" aria-hidden="true">↕</div>
            <div class="matching-column">
            
              <button
                type="button"
                class="matching-option"
                *ngFor="let option of availableMatchingRightOptions"
                (click)="onSelectMatchingRight(option.id)"
                [class.selected]="isRightSelected(option.id)"
                [disabled]="incorrectFeedback || showingExplanation"
              >
                {{ option.text }}
              </button>
            </div>
          </div>

          <div class="matched-pairs" *ngIf="matchingPairs.length">
            <div class="matched-pair" *ngFor="let pair of matchingPairs">
              <div class="pair-text">
                <span class="pair-left">{{ pair.leftText }}</span>
                <span class="pair-divider">↔</span>
                <span class="pair-right">{{ pair.rightText }}</span>
              </div>
              <button
                type="button"
                class="pair-remove"
                (click)="removeMatchingPair(pair)"
                [disabled]="incorrectFeedback || showingExplanation"
                aria-label="Удалить пару"
              >
                ×
              </button>
            </div>
          </div>
        </div>

        <ng-template #standardOptions>
          <div class="options-container">
            <div
              *ngFor="let option of task.options; let i = index"
              class="option-item"
              [class.selected]="selectedOptionIds.has(option.id)"
              [class.incorrect]="incorrectFeedback && selectedOptionIds.has(option.id)"
              [class.correct]="showingExplanation && isOptionCorrect(option.id)"
              [class.disabled]="incorrectFeedback || showingExplanation"
              (click)="onOptionToggle(option.id)"
            >
              <div class="option-number">{{ i + 1 }}</div>
              <div class="option-content">
                <div class="option-label" [innerHTML]="option.label"></div>
                <img
                  *ngIf="option.imageUrl"
                  [src]="option.imageUrl"
                  alt="Option image"
                  class="option-image"
                />
              </div>
              <div class="option-radio">
                <!-- checkbox-style indicator for multi-select -->
                <div class="checkbox-box" [class.checked]="selectedOptionIds.has(option.id)">
                  <div class="checkmark" *ngIf="selectedOptionIds.has(option.id)">✓</div>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </ng-template>

      <!-- Submit button -->
      <div class="submit-container" *ngIf="!showingExplanation">
        <ng-container *ngIf="!incorrectFeedback; else tryAgainButton">
          <button
            class="submit-button"
            [disabled]="!canSubmit || submitting"
            (click)="onSubmit()"
          >
            <span *ngIf="!submitting">Submit</span>
            <span *ngIf="submitting">Submitting...</span>
          </button>
        </ng-container>
        <ng-template #tryAgainButton>
          <button
            class="submit-button try-again-button"
            (click)="onTryAgain()"
            [disabled]="submitting"
          >
            <span *ngIf="!submitting">Try Again</span>
            <span *ngIf="submitting">Processing...</span>
          </button>
        </ng-template>
      </div>

      <div *ngIf="showingExplanation" class="explanation-panel">
        <div class="explanation-text" [innerHTML]="explanationText"></div>
        <button class="continue-button" (click)="onContinue()">
          {{ 'game.task.actions.next' | translate }}
        </button>
      </div>
    </div>
  </ng-template>
</div>
